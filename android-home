#!/usr/bin/env bash

INSTALL_DIR="$HOME/.android-home"
SCRIPTS_DIR="$INSTALL_DIR/scripts"

# Services known to this repo (must have a setup.sh)
SERVICES=(filebrowser cloudflare-tunnel)

_is_installed() {
    case "$1" in
        filebrowser)       command -v filebrowser &>/dev/null ;;
        cloudflare-tunnel) command -v cloudflared &>/dev/null ;;
    esac
}

case "$1" in
    setup)
        [[ -z "$2" ]] && { echo "Usage: android-home setup <service|all>"; exit 1; }
        if [[ "$2" == "all" ]]; then
            for svc in "${SERVICES[@]}"; do bash "$SCRIPTS_DIR/$svc/setup.sh"; done
        else
            bash "$SCRIPTS_DIR/$2/setup.sh"
        fi
        ;;
    run)
        [[ -z "$2" ]] && { echo "Usage: android-home run <service>"; exit 1; }
        bash "$SCRIPTS_DIR/$2/start.sh" "${@:3}"
        ;;
    start)
        [[ -z "$2" ]] && { echo "Usage: android-home start <service>"; exit 1; }
        sv start "$2"
        ;;
    stop)
        [[ -z "$2" ]] && { echo "Usage: android-home stop <service>"; exit 1; }
        sv stop "$2"
        ;;
    status)
        bash "$SCRIPTS_DIR/lib/status.sh"
        ;;
    services)
        echo "Available services:"
        for svc in "${SERVICES[@]}"; do
            if _is_installed "$svc"; then
                echo "  $svc [installed]"
            else
                echo "  $svc"
            fi
        done
        ;;
    completion)
        if ! command -v bash-completion &>/dev/null && [[ ! -f "$PREFIX/share/bash-completion/bash_completion" ]]; then
            echo "Installing bash-completion..."
            pkg install -y bash-completion
        fi
        dest="$PREFIX/share/bash-completion/completions/android-home"
        ln -sf "$SCRIPTS_DIR/lib/completion.bash" "$dest"
        echo "Bash completion enabled. Restart your shell or run:"
        echo "  source $dest"
        ;;
    update)
        bash "$SCRIPTS_DIR/lib/update.sh"
        ;;
    help|--help|-h|"")
        cat <<HELP
Usage: android-home <command> [options]

Commands:
  setup <service>    Setup a service (${SERVICES[*]}, all)
  run <service>      Run a service in the foreground
  start <service>    Start a service via runit (sv start)
  stop <service>     Stop a service via runit (sv stop)
  services           List available services with install status
  status             Show running service status
  completion         Enable bash tab completion
  update             Update to latest version
HELP
        ;;
    *)
        echo "Unknown command: $1. Run 'android-home help' for usage"
        exit 1
        ;;
esac
