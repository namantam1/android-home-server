#!/usr/bin/env bash

INSTALL_DIR="$HOME/.android-home"
SCRIPTS_DIR="$INSTALL_DIR/scripts"
LIB="$SCRIPTS_DIR/lib"

SERVICES=(filebrowser cloudflare-tunnel)

source "$LIB/service.sh"

_is_installed() {
    case "$1" in
        filebrowser)       command -v filebrowser &>/dev/null ;;
        cloudflare-tunnel) command -v cloudflared &>/dev/null ;;
    esac
}

case "$1" in
    setup)
        [[ -z "$2" ]] && { echo "Usage: android-home setup <service|all>"; exit 1; }
        if [[ "$2" == "all" ]]; then
            for svc in "${SERVICES[@]}"; do bash "$SCRIPTS_DIR/$svc/setup.sh"; done
        else
            bash "$SCRIPTS_DIR/$2/setup.sh"
        fi
        ;;
    run)
        [[ -z "$2" ]] && { echo "Usage: android-home run <service>"; exit 1; }
        bash "$SCRIPTS_DIR/$2/start.sh" "${@:3}"
        ;;
    start)
        [[ -z "$2" ]] && { echo "Usage: android-home start <service>"; exit 1; }
        sv start "$2"
        ;;
    stop)
        [[ -z "$2" ]] && { echo "Usage: android-home stop <service>"; exit 1; }
        sv stop "$2"
        ;;
    restart)
        [[ -z "$2" ]] && { echo "Usage: android-home restart <service>"; exit 1; }
        sv restart "$2"
        ;;
    enable)
        [[ -z "$2" ]] && { echo "Usage: android-home enable <service>"; exit 1; }
        enable_service "$2"
        ;;
    disable)
        [[ -z "$2" ]] && { echo "Usage: android-home disable <service>"; exit 1; }
        disable_service "$2"
        ;;
    logs)
        [[ -z "$2" ]] && { echo "Usage: android-home logs <service>"; exit 1; }
        tail -f "$PREFIX/var/log/sv/$2/current"
        ;;
    status)
        bash "$LIB/status.sh"
        ;;
    services)
        echo "Available services:"
        for svc in "${SERVICES[@]}"; do
            flag=""
            _is_installed "$svc" && flag=" [installed]"
            _is_enabled "$svc"   && flag+=" [enabled]"
            echo "  $svc$flag"
        done
        ;;
    ip)
        bash "$LIB/get-ip.sh"
        ;;
    info)
        bash "$LIB/info.sh"
        ;;
    doctor)
        bash "$LIB/doctor.sh"
        ;;
    backup)
        bash "$LIB/backup.sh" "$2"
        ;;
    restore)
        bash "$LIB/restore.sh" "$2"
        ;;
    completion)
        if [[ ! -f "$PREFIX/share/bash-completion/bash_completion" ]]; then
            echo "Installing bash-completion..."
            pkg install -y bash-completion
        fi
        dest="$PREFIX/share/bash-completion/completions/android-home"
        ln -sf "$LIB/completion.bash" "$dest"
        echo "Bash completion enabled. Restart your shell or run:"
        echo "  source $dest"
        ;;
    update)
        bash "$LIB/update.sh"
        ;;
    help|--help|-h|"")
        cat <<HELP
Usage: android-home <command> [options]

Service management:
  setup <service|all>   Install a service
  enable <service>      Register with runit (auto-start on boot)
  disable <service>     Unregister from runit
  start <service>       sv start
  stop <service>        sv stop
  restart <service>     sv restart
  run <service>         Run in foreground (for debugging)
  logs <service>        Tail service logs

System:
  services              List services with install/enabled status
  status                Show running status
  ip                    Print LAN IP address
  info                  System summary (storage, battery, services)
  doctor                Run health checks

Data:
  backup [dest]         Archive config files
  restore <file>        Restore from backup

Other:
  completion            Enable bash tab completion
  update                Update to latest version
HELP
        ;;
    *)
        echo "Unknown command: $1. Run 'android-home help' for usage"
        exit 1
        ;;
esac
